<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Generation Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .question-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üêõ‚û°Ô∏è‚úÖ Quiz Generation Fix Test</h1>
    <p>This page tests the fix for the "0 questions generated" issue in the AI Quiz Generator.</p>

    <div class="test-section">
        <h2>üîß Issue Fixed</h2>
        <p><strong>Problem:</strong> Quiz generator was showing "Quiz generated! Verification in progress..." but displaying 0 questions.</p>
        <p><strong>Root Cause:</strong> Backend response format mismatch - questions were returned separately from quiz object.</p>
        <p><strong>Solution:</strong> Modified backend to include questions in the quiz object with frontend-expected format.</p>
    </div>

    <div class="test-section">
        <h2>üß™ Test Quiz Generation API</h2>
        <div id="test-status" class="status info">Ready to test the API...</div>
        
        <button onclick="testLoginAndGenerate()">Test Complete Flow</button>
        <button onclick="clearLog()">Clear Log</button>
        
        <h3>Test Results:</h3>
        <div id="test-log" class="log-area">
            Test log will appear here...\n
        </div>
        
        <div id="question-preview" style="display: none;">
            <h3>üìù Generated Questions Preview:</h3>
            <div id="questions-container"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>‚úÖ Verification</h2>
        <p>After the fix, the quiz generation should:</p>
        <ul>
            <li>‚úÖ Show "Quiz generated! Verification in progress..."</li>
            <li>‚úÖ Display the correct number of questions (not 0)</li>
            <li>‚úÖ Show question text, options A-D, and explanations</li>
            <li>‚úÖ Allow saving the quiz</li>
        </ul>
        
        <p><strong>Frontend URL:</strong> <a href="http://localhost:3000/admin/ai-quiz" target="_blank">http://localhost:3000/admin/ai-quiz</a></p>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let testLog = '';
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const emoji = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            const logMessage = `[${timestamp}] ${emoji} ${message}\n`;
            testLog += logMessage;
            document.getElementById('test-log').textContent = testLog;
            
            // Auto-scroll to bottom
            const logElement = document.getElementById('test-log');
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            testLog = '';
            document.getElementById('test-log').textContent = 'Test log cleared...\n';
            document.getElementById('question-preview').style.display = 'none';
        }
        
        async function testLoginAndGenerate() {
            const statusDiv = document.getElementById('test-status');
            statusDiv.textContent = 'Testing complete flow...';
            statusDiv.className = 'status info';
            
            try {
                log('Starting complete quiz generation test...');
                
                // Step 1: Login
                log('Step 1: Logging in as admin...');
                const loginResp = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: 'admin@prepcheck.com', password: 'admin123' })
                });
                
                if (!loginResp.ok) {
                    throw new Error(`Login failed: ${loginResp.status}`);
                }
                
                const loginData = await loginResp.json();
                const token = loginData.access_token;
                log('‚úÖ Login successful', 'success');
                
                // Step 2: Get subjects
                log('Step 2: Getting subjects...');
                const subjectsResp = await fetch(`${API_BASE}/admin/subjects`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!subjectsResp.ok) {
                    throw new Error(`Subjects request failed: ${subjectsResp.status}`);
                }
                
                const subjects = await subjectsResp.json();
                log(`‚úÖ Found ${subjects.length} subjects`, 'success');
                
                if (subjects.length === 0) {
                    throw new Error('No subjects available');
                }
                
                // Step 3: Get chapters
                log('Step 3: Getting chapters...');
                const subjectId = subjects[0].id;
                const chaptersResp = await fetch(`${API_BASE}/admin/chapters?subject_id=${subjectId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!chaptersResp.ok) {
                    throw new Error(`Chapters request failed: ${chaptersResp.status}`);
                }
                
                const chapters = await chaptersResp.json();
                log(`‚úÖ Found ${chapters.length} chapters for subject "${subjects[0].name}"`, 'success');
                
                if (chapters.length === 0) {
                    throw new Error('No chapters available for the subject');
                }
                
                // Step 4: Generate quiz
                log('Step 4: Generating quiz...');
                const quizData = {
                    subject_id: subjectId,
                    chapter_id: chapters[0].id,
                    topic: 'Test Topic - Fix Verification',
                    difficulty: 'medium',
                    num_questions: 3,
                    context: 'Testing the fix for 0 questions issue'
                };
                
                log(`Requesting quiz: "${quizData.topic}" (${quizData.num_questions} questions)`);
                
                const quizResp = await fetch(`${API_BASE}/ai/generate-quiz`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(quizData)
                });
                
                if (!quizResp.ok) {
                    const errorText = await quizResp.text();
                    throw new Error(`Quiz generation failed: ${quizResp.status} - ${errorText}`);
                }
                
                const quizResult = await quizResp.json();
                log('‚úÖ Quiz generation API call successful', 'success');
                
                // Step 5: Verify response format
                log('Step 5: Verifying response format...');
                
                if (!quizResult.quiz) {
                    throw new Error('Response missing "quiz" object');
                }
                
                const quiz = quizResult.quiz;
                if (!quiz.questions) {
                    throw new Error('Quiz object missing "questions" array');
                }
                
                const questions = quiz.questions;
                log(`‚úÖ Quiz contains ${questions.length} questions (expected: ${quizData.num_questions})`, 'success');
                
                if (questions.length === 0) {
                    throw new Error('‚ùå STILL GENERATING 0 QUESTIONS - FIX DID NOT WORK');
                }
                
                // Step 6: Verify question format
                log('Step 6: Verifying question format...');
                
                for (let i = 0; i < questions.length; i++) {
                    const q = questions[i];
                    
                    if (!q.question) {
                        throw new Error(`Question ${i+1} missing "question" field`);
                    }
                    
                    if (!q.options || typeof q.options !== 'object') {
                        throw new Error(`Question ${i+1} missing or invalid "options" field`);
                    }
                    
                    if (!q.options.A || !q.options.B || !q.options.C || !q.options.D) {
                        throw new Error(`Question ${i+1} missing option A, B, C, or D`);
                    }
                    
                    if (!q.correct_answer) {
                        throw new Error(`Question ${i+1} missing "correct_answer" field`);
                    }
                    
                    if (!['A', 'B', 'C', 'D'].includes(q.correct_answer)) {
                        throw new Error(`Question ${i+1} has invalid correct_answer: ${q.correct_answer}`);
                    }
                }
                
                log('‚úÖ All questions have correct format', 'success');
                
                // Step 7: Display questions
                displayQuestions(questions);
                
                statusDiv.textContent = '‚úÖ All tests passed! Quiz generation is working correctly.';
                statusDiv.className = 'status success';
                
                log('üéâ TEST COMPLETED SUCCESSFULLY - Quiz generation fix is working!', 'success');
                
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
                statusDiv.textContent = `‚ùå Test failed: ${error.message}`;
                statusDiv.className = 'status error';
            }
        }
        
        function displayQuestions(questions) {
            const container = document.getElementById('questions-container');
            const preview = document.getElementById('question-preview');
            
            container.innerHTML = '';
            
            questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-preview';
                questionDiv.innerHTML = `
                    <h4>Question ${index + 1}</h4>
                    <p><strong>Q:</strong> ${q.question}</p>
                    <div style="margin-left: 20px;">
                        <div>A) ${q.options.A}</div>
                        <div>B) ${q.options.B}</div>
                        <div>C) ${q.options.C}</div>
                        <div>D) ${q.options.D}</div>
                    </div>
                    <p><strong>Correct Answer:</strong> ${q.correct_answer}</p>
                    <p><strong>Explanation:</strong> ${q.explanation}</p>
                    <p><strong>Marks:</strong> ${q.marks}</p>
                `;
                container.appendChild(questionDiv);
            });
            
            preview.style.display = 'block';
        }
        
        // Initialize
        window.onload = function() {
            log('Quiz Generation Fix Test loaded');
        };
    </script>
</body>
</html>
