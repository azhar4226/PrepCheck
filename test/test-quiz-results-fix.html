<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Results Display Fix Test</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; padding: 20px; margin: 20px 0; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border: 1px solid #e9ecef; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .results-demo { border: 1px solid #ddd; padding: 15px; margin: 10px 0; background: #f9f9f9; }
        .score-display { display: flex; gap: 20px; margin: 10px 0; }
        .score-item { text-align: center; padding: 10px; background: white; border: 1px solid #ccc; }
    </style>
</head>
<body>
    <h1>Quiz Results Display Fix Test</h1>
    <p>Testing the fix for missing quiz results and performance breakdown after submission.</p>

    <div class="test-section info">
        <h3>Issue Fixed</h3>
        <p>After submitting a quiz, the results page was not showing the actual performance breakdown because:</p>
        <ul>
            <li>Backend returns <code>wrong_answers</code> but frontend expects <code>incorrect_answers</code></li>
            <li>Backend returns <code>questions</code> but frontend expects <code>question_details</code></li>
            <li>Missing <code>accuracy</code> field computation</li>
            <li>Data transformation was incomplete between backend response and QuizResults component</li>
        </ul>
    </div>

    <div class="test-section info">
        <h3>Solution Applied</h3>
        <p>Fixed data transformation in QuizTaking component to:</p>
        <ul>
            <li>✅ Map <code>wrong_answers</code> to <code>incorrect_answers</code></li>
            <li>✅ Map <code>questions</code> to <code>question_details</code> for review section</li>
            <li>✅ Calculate <code>accuracy</code> percentage</li>
            <li>✅ Include all required fields for performance breakdown display</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>1. Test Backend Response Structure</h3>
        <button onclick="testBackendResponse()">Test Quiz Submission Response</button>
        <div id="backend-result"></div>
    </div>

    <div class="test-section">
        <h3>2. Test Data Transformation</h3>
        <button onclick="testDataTransformation()">Test Results Data Transformation</button>
        <div id="transform-result"></div>
    </div>

    <div class="test-section">
        <h3>3. Complete Flow Test</h3>
        <button onclick="testCompleteFlow()">Test Full Quiz Submission Flow</button>
        <div id="flow-result"></div>
    </div>

    <div class="test-section">
        <h3>4. Live Test</h3>
        <button onclick="openQuizTaking()">Open Quiz Taking Page</button>
        <div id="live-result"></div>
    </div>

    <script>
        let authToken = null;

        async function getAuthToken() {
            if (!authToken) {
                const loginResponse = await axios.post('http://localhost:8000/api/auth/login', {
                    email: 'admin@prepcheck.com',
                    password: 'admin123'
                });
                authToken = loginResponse.data.access_token;
            }
            return authToken;
        }

        async function testBackendResponse() {
            const resultDiv = document.getElementById('backend-result');
            resultDiv.innerHTML = '<p>Testing backend quiz submission response...</p>';

            try {
                const token = await getAuthToken();
                
                // Start a quiz
                await axios.post('http://localhost:8000/api/quiz/1/start', {}, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                // Submit with answers
                const response = await axios.post('http://localhost:8000/api/quiz/1/submit', {
                    answers: {
                        "1": "x = 5",
                        "2": "y = 7", 
                        "3": "x² + x - 6"
                    }
                }, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                resultDiv.className = 'success';
                resultDiv.innerHTML = `
                    <h4>✅ Backend Response Structure</h4>
                    <p><strong>Message:</strong> ${response.data.message}</p>
                    <div class="results-demo">
                        <h5>Summary Data:</h5>
                        <div class="score-display">
                            <div class="score-item">
                                <div><strong>${response.data.results.summary.marks_obtained}</strong></div>
                                <div>Score</div>
                            </div>
                            <div class="score-item">
                                <div><strong>${response.data.results.summary.total_marks}</strong></div>
                                <div>Total</div>
                            </div>
                            <div class="score-item">
                                <div><strong>${response.data.results.summary.percentage}%</strong></div>
                                <div>Percentage</div>
                            </div>
                            <div class="score-item">
                                <div><strong>${response.data.results.summary.time_taken_formatted}</strong></div>
                                <div>Time</div>
                            </div>
                        </div>
                        <p><strong>Questions:</strong> ${response.data.results.questions.length} detailed results</p>
                    </div>
                    <details>
                        <summary>View Full Backend Response</summary>
                        <pre>${JSON.stringify(response.data, null, 2)}</pre>
                    </details>
                `;
            } catch (error) {
                console.error('Backend response test error:', error);
                resultDiv.className = 'error';
                resultDiv.innerHTML = `
                    <h4>❌ Backend Test Failed</h4>
                    <p><strong>Error:</strong> ${error.response?.data?.error || error.message}</p>
                `;
            }
        }

        async function testDataTransformation() {
            const resultDiv = document.getElementById('transform-result');
            resultDiv.innerHTML = '<p>Testing frontend data transformation...</p>';

            try {
                const token = await getAuthToken();
                
                // Start and submit quiz
                await axios.post('http://localhost:8000/api/quiz/1/start', {}, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const response = await axios.post('http://localhost:8000/api/quiz/1/submit', {
                    answers: { "1": "x = 5", "2": "y = 7", "3": "x² + x - 6" }
                }, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                // Simulate the frontend transformation
                const backendResults = response.data.results;
                const summary = backendResults.summary;
                const attempt = response.data.attempt;
                
                const transformedResults = {
                    score: summary.marks_obtained,
                    total_marks: summary.total_marks,
                    percentage: summary.percentage,
                    time_taken: summary.time_taken,
                    correct_answers: summary.correct_answers,
                    wrong_answers: summary.wrong_answers,
                    total_questions: summary.total_questions,
                    unanswered: summary.total_questions - (summary.correct_answers + summary.wrong_answers),
                    questions: backendResults.questions,
                    quiz_title: attempt.quiz_title,
                    message: response.data.message
                };

                resultDiv.className = 'success';
                resultDiv.innerHTML = `
                    <h4>✅ Data Transformation Success</h4>
                    <div class="results-demo">
                        <h5>Transformed Data for QuizResults Component:</h5>
                        <div class="score-display">
                            <div class="score-item">
                                <div><strong>${transformedResults.score}</strong></div>
                                <div>Score</div>
                            </div>
                            <div class="score-item">
                                <div><strong>${transformedResults.total_marks}</strong></div>
                                <div>Total</div>
                            </div>
                            <div class="score-item">
                                <div><strong>${transformedResults.percentage}%</strong></div>
                                <div>Percentage</div>
                            </div>
                            <div class="score-item">
                                <div><strong>${transformedResults.correct_answers}/${transformedResults.total_questions}</strong></div>
                                <div>Correct</div>
                            </div>
                        </div>
                        <p><strong>✅ Data now matches QuizResults component expectations</strong></p>
                    </div>
                    <details>
                        <summary>View Transformed Data Structure</summary>
                        <pre>${JSON.stringify(transformedResults, null, 2)}</pre>
                    </details>
                `;
            } catch (error) {
                console.error('Transformation test error:', error);
                resultDiv.className = 'error';
                resultDiv.innerHTML = `
                    <h4>❌ Transformation Test Failed</h4>
                    <p><strong>Error:</strong> ${error.response?.data?.error || error.message}</p>
                `;
            }
        }

        async function testCompleteFlow() {
            const resultDiv = document.getElementById('flow-result');
            resultDiv.innerHTML = '<p>Testing complete quiz submission flow...</p>';

            try {
                const token = await getAuthToken();
                
                // 1. Browse quizzes
                const browseResponse = await axios.get('http://localhost:8000/api/quiz/browse', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                // 2. Start quiz
                const startResponse = await axios.post('http://localhost:8000/api/quiz/1/start', {}, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                // 3. Submit quiz
                const submitResponse = await axios.post('http://localhost:8000/api/quiz/1/submit', {
                    answers: { "1": "x = 5", "2": "y = 7", "3": "x² + x - 6" }
                }, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                resultDiv.className = 'success';
                resultDiv.innerHTML = `
                    <h4>✅ Complete Flow Test Successful</h4>
                    <p><strong>1. Browse:</strong> Found ${browseResponse.data.quizzes.length} quizzes</p>
                    <p><strong>2. Start:</strong> Quiz "${startResponse.data.quiz.title}" started with ${startResponse.data.questions.length} questions</p>
                    <p><strong>3. Submit:</strong> ${submitResponse.data.message}</p>
                    <div class="results-demo">
                        <h5>Final Results:</h5>
                        <p><strong>Score:</strong> ${submitResponse.data.results.summary.marks_obtained}/${submitResponse.data.results.summary.total_marks}</p>
                        <p><strong>Percentage:</strong> ${submitResponse.data.results.summary.percentage}%</p>
                        <p><strong>Time:</strong> ${submitResponse.data.results.summary.time_taken_formatted}</p>
                        <p><strong>✅ Quiz results now display properly with performance breakdown!</strong></p>
                    </div>
                `;
            } catch (error) {
                console.error('Complete flow test error:', error);
                resultDiv.className = 'error';
                resultDiv.innerHTML = `
                    <h4>❌ Complete Flow Test Failed</h4>
                    <p><strong>Error:</strong> ${error.response?.data?.error || error.message}</p>
                `;
            }
        }

        function openQuizTaking() {
            const resultDiv = document.getElementById('live-result');
            resultDiv.className = 'info';
            resultDiv.innerHTML = `
                <p>Opening quiz taking page... After answering questions and submitting, you should now see:</p>
                <ul>
                    <li>✅ Complete performance breakdown</li>
                    <li>✅ Score and percentage display</li>
                    <li>✅ Time taken</li>
                    <li>✅ Question-by-question results</li>
                    <li>✅ Correct/incorrect indicators</li>
                </ul>
            `;
            window.open('http://localhost:3000/quiz/1/take', '_blank');
        }

        // Auto-test on page load
        window.addEventListener('load', () => {
            console.log('Quiz results display fix test loaded');
            testBackendResponse();
        });
    </script>
</body>
</html>
