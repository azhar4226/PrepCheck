<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Quiz Generator Functionality Test</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .test-container { max-width: 800px; margin: 0 auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div id="app" class="test-container">
        <h1>ü§ñ AI Quiz Generator - Standalone Dropdowns Test</h1>
        
        <div class="status success">
            ‚úÖ Testing the new standalone Subject and Chapter dropdowns
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5>Dropdown Functionality Test</h5>
            </div>
            <div class="card-body">
                <!-- Subject Dropdown -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Subject</label>
                    <select v-model="form.subject_id" class="form-select" @change="onSubjectChange">
                        <option value="">Select a subject...</option>
                        <option v-for="subject in subjects" :key="subject.id" :value="subject.id">
                            {{ subject.name }} ({{ subject.chapters_count }} chapters)
                        </option>
                    </select>
                    <div v-if="subjectsLoading" class="form-text">
                        <span class="spinner-border spinner-border-sm me-1"></span>
                        Loading subjects...
                    </div>
                </div>

                <!-- Chapter Dropdown -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Chapter</label>
                    <select v-model="form.chapter_id" class="form-select" :disabled="!form.subject_id || loadingChapters">
                        <option value="">{{ form.subject_id ? 'Select a chapter...' : 'Select a subject first' }}</option>
                        <option v-for="chapter in chapters" :key="chapter.id" :value="chapter.id">
                            {{ chapter.name }}
                        </option>
                    </select>
                    <div v-if="loadingChapters" class="form-text">
                        <span class="spinner-border spinner-border-sm me-1"></span>
                        Loading chapters...
                    </div>
                </div>

                <!-- Test Results -->
                <div class="mt-4">
                    <h6>Test Results:</h6>
                    <div class="status info">
                        <strong>Selected Subject:</strong> {{ selectedSubjectName || 'None' }}<br>
                        <strong>Selected Chapter:</strong> {{ selectedChapterName || 'None' }}<br>
                        <strong>Subjects Loaded:</strong> {{ subjects.length }}<br>
                        <strong>Chapters Available:</strong> {{ chapters.length }}
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="mt-3">
                    <button @click="loadSubjects" class="btn btn-primary me-2" :disabled="subjectsLoading">
                        {{ subjectsLoading ? 'Loading...' : 'Reload Subjects' }}
                    </button>
                    <button @click="testAPIConnectivity" class="btn btn-info">
                        Test API Connectivity
                    </button>
                </div>
            </div>
        </div>

        <!-- API Test Results -->
        <div class="card mt-4" v-if="apiTestResults.length > 0">
            <div class="card-header">
                <h5>API Test Results</h5>
            </div>
            <div class="card-body">
                <div v-for="result in apiTestResults" :key="result.endpoint" class="mb-2">
                    <span class="badge" :class="result.success ? 'bg-success' : 'bg-danger'">
                        {{ result.success ? '‚úÖ' : '‚ùå' }} {{ result.endpoint }}
                    </span>
                    <span class="ms-2">{{ result.message }}</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    form: {
                        subject_id: '',
                        chapter_id: ''
                    },
                    subjects: [],
                    chapters: [],
                    subjectsLoading: false,
                    loadingChapters: false,
                    apiTestResults: []
                }
            },
            computed: {
                selectedSubjectName() {
                    const subject = this.subjects.find(s => s.id == this.form.subject_id);
                    return subject ? subject.name : null;
                },
                selectedChapterName() {
                    const chapter = this.chapters.find(c => c.id == this.form.chapter_id);
                    return chapter ? chapter.name : null;
                }
            },
            async mounted() {
                await this.loadSubjects();
            },
            methods: {
                async loadSubjects() {
                    this.subjectsLoading = true;
                    try {
                        const response = await axios.get('http://localhost:8000/api/admin/subjects', {
                            headers: {
                                'Authorization': 'Bearer ' + this.getToken()
                            }
                        });
                        this.subjects = response.data;
                        console.log('Loaded subjects:', this.subjects);
                    } catch (error) {
                        console.error('Failed to load subjects:', error);
                        alert('Failed to load subjects. Please check console for details.');
                    } finally {
                        this.subjectsLoading = false;
                    }
                },
                
                async loadChapters(subjectId) {
                    if (!subjectId) {
                        this.chapters = [];
                        return;
                    }
                    
                    this.loadingChapters = true;
                    try {
                        const response = await axios.get(`http://localhost:8000/api/admin/chapters?subject_id=${subjectId}`, {
                            headers: {
                                'Authorization': 'Bearer ' + this.getToken()
                            }
                        });
                        this.chapters = response.data;
                        console.log('Loaded chapters for subject', subjectId, ':', this.chapters);
                    } catch (error) {
                        console.error('Failed to load chapters:', error);
                        this.chapters = [];
                    } finally {
                        this.loadingChapters = false;
                    }
                },
                
                async onSubjectChange() {
                    // Reset chapter selection when subject changes
                    this.form.chapter_id = '';
                    this.chapters = [];
                    
                    if (this.form.subject_id) {
                        await this.loadChapters(this.form.subject_id);
                    }
                },
                
                getToken() {
                    // For testing, we'll use a hardcoded token
                    // In real app, this would come from localStorage
                    return 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmcmVzaCI6ZmFsc2UsImlhdCI6MTc0OTkyODQyMywianRpIjoiZWFhOWMxZjgtYzViMy00YmNjLWJjNTItZmJiYjEwODAyNTZiIiwidHlwZSI6ImFjY2VzcyIsInN1YiI6IjEiLCJuYmYiOjE3NDk5Mjg0MjMsImV4cCI6MTc1MDAxNDgyM30.RdNuJ3pVnhc_89YwA6Nt_yqITbnm4-wPnXSAVhjLpxk';
                },
                
                async testAPIConnectivity() {
                    this.apiTestResults = [];
                    
                    // Test subjects endpoint
                    try {
                        await axios.get('http://localhost:8000/api/admin/subjects', {
                            headers: { 'Authorization': 'Bearer ' + this.getToken() }
                        });
                        this.apiTestResults.push({
                            endpoint: 'GET /api/admin/subjects',
                            success: true,
                            message: 'Successfully loaded subjects'
                        });
                    } catch (error) {
                        this.apiTestResults.push({
                            endpoint: 'GET /api/admin/subjects',
                            success: false,
                            message: 'Failed: ' + error.message
                        });
                    }
                    
                    // Test chapters endpoint
                    if (this.form.subject_id) {
                        try {
                            await axios.get(`http://localhost:8000/api/admin/chapters?subject_id=${this.form.subject_id}`, {
                                headers: { 'Authorization': 'Bearer ' + this.getToken() }
                            });
                            this.apiTestResults.push({
                                endpoint: 'GET /api/admin/chapters',
                                success: true,
                                message: 'Successfully loaded chapters'
                            });
                        } catch (error) {
                            this.apiTestResults.push({
                                endpoint: 'GET /api/admin/chapters',
                                success: false,
                                message: 'Failed: ' + error.message
                            });
                        }
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
