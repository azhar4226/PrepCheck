<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Management Chapter Dropdown Test</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
        .status { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { margin: 5px; padding: 10px 15px; }
        .dropdown-section { border: 1px solid #ccc; padding: 15px; margin: 15px 0; border-radius: 5px; }
        select { width: 200px; padding: 5px; margin: 5px 0; }
        .fix-item { margin: 5px 0; }
    </style>
</head>
<body>
    <h1>Quiz Management - Chapter Dropdown & Create Quiz Fix</h1>
    <div id="status" class="status info">Testing Quiz Management fixes...</div>
    
    <h3>üõ†Ô∏è Issues Fixed:</h3>
    <div class="fix-item">‚úÖ <strong>Chapter Dropdown Loading:</strong> Added loadChapters() function to fetch chapters for selected subject</div>
    <div class="fix-item">‚úÖ <strong>Subject-Chapter Relationship:</strong> Added watcher to load chapters when subject changes</div>
    <div class="fix-item">‚úÖ <strong>API Service Methods:</strong> Added updateQuiz() and deleteQuiz() methods to API service</div>
    <div class="fix-item">‚úÖ <strong>Create Quiz Button:</strong> Fixed saveQuiz() to use proper apiService.createQuiz() method</div>
    <div class="fix-item">‚úÖ <strong>Response Handling:</strong> Removed dependency on non-existent response.data.success structure</div>
    
    <h3>üß™ Test APIs:</h3>
    <button onclick="testLogin()">1. Login as Admin</button>
    <button onclick="testSubjects()" id="subjectsBtn" disabled>2. Get Subjects</button>
    <button onclick="testChapters()" id="chaptersBtn" disabled>3. Get Chapters</button>
    <button onclick="testCreateQuiz()" id="createQuizBtn" disabled>4. Create Quiz</button>
    
    <div id="test-result"></div>
    
    <h3>üìù Simulated Quiz Creation Flow:</h3>
    <div class="dropdown-section">
        <h4>Step 1: Select Subject</h4>
        <label>Subject: </label>
        <select id="subjectSelect" onchange="loadChaptersForSubject()">
            <option value="">Select Subject</option>
        </select>
        
        <h4>Step 2: Select Chapter (populated based on subject)</h4>
        <label>Chapter: </label>
        <select id="chapterSelect">
            <option value="">Select Chapter</option>
        </select>
        
        <h4>Step 3: Quiz Details</h4>
        <label>Quiz Title: </label>
        <input type="text" id="quizTitle" placeholder="Enter quiz title" style="width: 200px; padding: 5px;">
        
        <br><br>
        <button onclick="simulateCreateQuiz()" id="simulateBtn" disabled>Simulate Create Quiz</button>
    </div>
    
    <h3>üîó Links to Test in Vue App:</h3>
    <ul>
        <li><a href="http://localhost:3001/admin/quizzes" target="_blank" rel="noopener">Quiz Management Page</a></li>
        <li><a href="http://localhost:3001/admin/subjects" target="_blank" rel="noopener">Subject Management Page</a></li>
    </ul>
    
    <script>
        let authToken = null;
        let currentSubjects = [];
        let currentChapters = [];
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
        }
        
        async function testLogin() {
            try {
                updateStatus('Testing admin login...', 'info');
                const response = await axios.post('http://localhost:8000/api/auth/login', {
                    email: 'admin@prepcheck.com',
                    password: 'admin123'
                });
                
                authToken = response.data.access_token;
                axios.defaults.headers.common['Authorization'] = `Bearer ${authToken}`;
                
                document.getElementById('test-result').innerHTML = 
                    `<div class="status success">‚úÖ Login successful!</div>`;
                document.getElementById('subjectsBtn').disabled = false;
                updateStatus('Login successful! Now test subjects API.', 'success');
            } catch (error) {
                document.getElementById('test-result').innerHTML = 
                    `<div class="status error">‚ùå Login failed: ${error.message}</div>`;
                updateStatus('Login failed!', 'error');
            }
        }
        
        async function testSubjects() {
            try {
                updateStatus('Testing subjects API...', 'info');
                const response = await axios.get('http://localhost:8000/api/admin/subjects');
                currentSubjects = response.data;
                
                // Populate subject dropdown
                const subjectSelect = document.getElementById('subjectSelect');
                subjectSelect.innerHTML = '<option value="">Select Subject</option>';
                currentSubjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.name;
                    subjectSelect.appendChild(option);
                });
                
                document.getElementById('test-result').innerHTML = 
                    `<div class="status success">‚úÖ Subjects loaded! Found ${currentSubjects.length} subjects</div>`;
                document.getElementById('chaptersBtn').disabled = false;
                updateStatus('Subjects loaded! Try selecting a subject above.', 'success');
            } catch (error) {
                document.getElementById('test-result').innerHTML = 
                    `<div class="status error">‚ùå Subjects failed: ${error.message}</div>`;
                updateStatus('Subjects test failed!', 'error');
            }
        }
        
        async function testChapters() {
            try {
                updateStatus('Testing chapters API for subject 1...', 'info');
                const response = await axios.get('http://localhost:8000/api/admin/chapters?subject_id=1');
                
                document.getElementById('test-result').innerHTML = 
                    `<div class="status success">‚úÖ Chapters loaded for Mathematics! Found ${response.data.length} chapters<br>
                    <strong>Chapters:</strong><br>
                    ${response.data.map(c => `‚Ä¢ ${c.name} (ID: ${c.id})`).join('<br>')}</div>`;
                document.getElementById('createQuizBtn').disabled = false;
                updateStatus('Chapters API working! Try the subject dropdown above.', 'success');
            } catch (error) {
                document.getElementById('test-result').innerHTML = 
                    `<div class="status error">‚ùå Chapters failed: ${error.message}</div>`;
                updateStatus('Chapters test failed!', 'error');
            }
        }
        
        async function testCreateQuiz() {
            try {
                updateStatus('Testing create quiz API...', 'info');
                const response = await axios.post('http://localhost:8000/api/admin/quizzes', {
                    title: 'Frontend Test Quiz',
                    description: 'Created from test page',
                    chapter_id: 1,
                    difficulty: 'medium',
                    is_active: true
                });
                
                document.getElementById('test-result').innerHTML = 
                    `<div class="status success">‚úÖ Quiz created successfully!<br>
                    <strong>Quiz ID:</strong> ${response.data.quiz.id}<br>
                    <strong>Title:</strong> ${response.data.quiz.title}<br>
                    <strong>Chapter:</strong> ${response.data.quiz.chapter_name}</div>`;
                updateStatus('Create quiz API working! Test the Vue app now.', 'success');
                document.getElementById('simulateBtn').disabled = false;
            } catch (error) {
                document.getElementById('test-result').innerHTML = 
                    `<div class="status error">‚ùå Create quiz failed: ${error.message}</div>`;
                updateStatus('Create quiz test failed!', 'error');
            }
        }
        
        async function loadChaptersForSubject() {
            const subjectId = document.getElementById('subjectSelect').value;
            const chapterSelect = document.getElementById('chapterSelect');
            
            if (!subjectId) {
                chapterSelect.innerHTML = '<option value="">Select Chapter</option>';
                return;
            }
            
            try {
                const response = await axios.get(`http://localhost:8000/api/admin/chapters?subject_id=${subjectId}`);
                currentChapters = response.data;
                
                chapterSelect.innerHTML = '<option value="">Select Chapter</option>';
                currentChapters.forEach(chapter => {
                    const option = document.createElement('option');
                    option.value = chapter.id;
                    option.textContent = chapter.name;
                    chapterSelect.appendChild(option);
                });
                
                updateStatus(`Loaded ${currentChapters.length} chapters for selected subject!`, 'success');
            } catch (error) {
                console.error('Failed to load chapters:', error);
                updateStatus('Failed to load chapters!', 'error');
            }
        }
        
        async function simulateCreateQuiz() {
            const subjectId = document.getElementById('subjectSelect').value;
            const chapterId = document.getElementById('chapterSelect').value;
            const title = document.getElementById('quizTitle').value;
            
            if (!subjectId || !chapterId || !title) {
                alert('Please select subject, chapter, and enter a title!');
                return;
            }
            
            try {
                const response = await axios.post('http://localhost:8000/api/admin/quizzes', {
                    title: title,
                    description: 'Created from simulation test',
                    chapter_id: parseInt(chapterId),
                    difficulty: 'medium',
                    is_active: true
                });
                
                alert(`Quiz "${response.data.quiz.title}" created successfully!`);
                updateStatus('Quiz creation simulation successful!', 'success');
            } catch (error) {
                alert('Failed to create quiz: ' + error.message);
                updateStatus('Quiz creation simulation failed!', 'error');
            }
        }
    </script>
</body>
</html>
