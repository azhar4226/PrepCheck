<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Management Complete Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background-color: #0056b3; }
        .btn-success { background-color: #28a745; }
        .btn-danger { background-color: #dc3545; }
        .output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        .status-card {
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 Complete Quiz Management Test</h1>
        <p>Comprehensive test to verify Quiz Management functionality after port fix</p>

        <div class="test-section info">
            <h3>📋 Test Overview</h3>
            <p>This test validates that QuizManagement.vue is working correctly with the backend on port 8000.</p>
            <div class="status-grid">
                <div id="backend-status" class="status-card">
                    <h4>🔧 Backend Status</h4>
                    <p>Not tested</p>
                </div>
                <div id="auth-status" class="status-card">
                    <h4>🔐 Authentication</h4>
                    <p>Not tested</p>
                </div>
                <div id="api-status" class="status-card">
                    <h4>📊 Quiz API</h4>
                    <p>Not tested</p>
                </div>
                <div id="network-status" class="status-card">
                    <h4>🌐 Network Issues</h4>
                    <p>Monitoring...</p>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h3>🚀 Quick Test Suite</h3>
            <button class="btn btn-success" onclick="runFullTestSuite()">Run All Tests</button>
            <button class="btn" onclick="testBackendHealth()">Test Backend</button>
            <button class="btn" onclick="testAuthentication()">Test Auth</button>
            <button class="btn" onclick="testQuizAPI()">Test Quiz API</button>
            <button class="btn btn-danger" onclick="checkNetworkErrors()">Check Network Errors</button>
        </div>

        <div class="test-section">
            <h3>📊 Test Results</h3>
            <div id="test-results" class="output">Click "Run All Tests" to start testing...</div>
        </div>

        <div class="test-section">
            <h3>🔍 Detailed Analysis</h3>
            <div id="detailed-analysis" class="output">Will be populated after tests run...</div>
        </div>

        <div class="test-section">
            <h3>🎯 Quiz Management Simulation</h3>
            <button class="btn" onclick="simulateQuizManagement()">Simulate Quiz Management Flow</button>
            <div id="simulation-output" class="output"></div>
        </div>

        <div class="test-section">
            <h3>🌐 Network Monitor</h3>
            <div id="network-monitor" class="output">Monitoring network requests...</div>
        </div>
    </div>

    <script>
        let authToken = null;
        let networkRequests = [];
        let testResults = {
            backend: null,
            auth: null,
            quizAPI: null,
            networkErrors: []
        };

        function updateStatus(section, status, message) {
            const statusCard = document.getElementById(`${section}-status`);
            if (statusCard) {
                statusCard.className = `status-card ${status}`;
                statusCard.querySelector('p').textContent = message;
            }
        }

        function log(message, section = 'test-results') {
            const timestamp = new Date().toLocaleTimeString();
            const output = document.getElementById(section);
            if (output) {
                output.innerHTML += `[${timestamp}] ${message}\n`;
                output.scrollTop = output.scrollHeight;
            }
        }

        // Network monitoring
        function initNetworkMonitoring() {
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                const url = typeof args[0] === 'string' ? args[0] : args[0].url;
                const method = args[1]?.method || 'GET';
                
                networkRequests.push({
                    type: 'fetch',
                    method,
                    url,
                    timestamp: Date.now()
                });
                
                log(`FETCH ${method}: ${url}`, 'network-monitor');
                
                return originalFetch.apply(this, args)
                    .then(response => {
                        log(`FETCH RESPONSE: ${url} - ${response.status}`, 'network-monitor');
                        return response;
                    })
                    .catch(error => {
                        log(`FETCH ERROR: ${url} - ${error.message}`, 'network-monitor');
                        testResults.networkErrors.push({
                            type: 'fetch',
                            url,
                            error: error.message
                        });
                        throw error;
                    });
            };

            const originalXHROpen = XMLHttpRequest.prototype.open;
            XMLHttpRequest.prototype.open = function(method, url, ...args) {
                this._method = method;
                this._url = url;
                
                networkRequests.push({
                    type: 'xhr',
                    method,
                    url,
                    timestamp: Date.now()
                });
                
                log(`XHR ${method}: ${url}`, 'network-monitor');
                return originalXHROpen.apply(this, [method, url, ...args]);
            };

            const originalXHRSend = XMLHttpRequest.prototype.send;
            XMLHttpRequest.prototype.send = function(...args) {
                this.addEventListener('load', () => {
                    log(`XHR RESPONSE: ${this._url} - ${this.status}`, 'network-monitor');
                });
                this.addEventListener('error', () => {
                    log(`XHR ERROR: ${this._url}`, 'network-monitor');
                    testResults.networkErrors.push({
                        type: 'xhr',
                        url: this._url,
                        error: 'Network error'
                    });
                });
                return originalXHRSend.apply(this, args);
            };
        }

        async function testBackendHealth() {
            log("🔧 Testing backend health...");
            
            try {
                const response = await fetch('http://localhost:8000/api/health', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    testResults.backend = true;
                    updateStatus('backend', 'success', 'Backend running on port 8000');
                    log("✅ Backend health check passed");
                    return true;
                } else {
                    throw new Error(`Backend responded with ${response.status}`);
                }
            } catch (error) {
                testResults.backend = false;
                updateStatus('backend', 'error', 'Backend connection failed');
                log(`❌ Backend health check failed: ${error.message}`);
                return false;
            }
        }

        async function testAuthentication() {
            log("🔐 Testing admin authentication...");
            
            try {
                const response = await fetch('http://localhost:8000/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@test.com',
                        password: 'admin123'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    authToken = data.data.access_token;
                    testResults.auth = true;
                    updateStatus('auth', 'success', `Authenticated as ${data.data.user.email}`);
                    log(`✅ Authentication successful for ${data.data.user.email}`);
                    return true;
                } else {
                    throw new Error(data.message || 'Authentication failed');
                }
            } catch (error) {
                testResults.auth = false;
                updateStatus('auth', 'error', 'Authentication failed');
                log(`❌ Authentication failed: ${error.message}`);
                return false;
            }
        }

        async function testQuizAPI() {
            log("📊 Testing Quiz Management API...");
            
            if (!authToken) {
                log("❌ No auth token available. Please authenticate first.");
                return false;
            }
            
            try {
                const response = await fetch('http://localhost:8000/api/admin/quizzes?page=1&per_page=10', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    testResults.quizAPI = true;
                    const quizCount = data.data?.quizzes?.length || 0;
                    updateStatus('api', 'success', `${quizCount} quizzes loaded`);
                    log(`✅ Quiz API test passed: ${quizCount} quizzes found`);
                    
                    // Log quiz details
                    if (data.data?.quizzes?.length > 0) {
                        log(`Quiz details: ${JSON.stringify(data.data.quizzes[0], null, 2)}`, 'detailed-analysis');
                    }
                    
                    return true;
                } else {
                    throw new Error(data.message || 'Quiz API request failed');
                }
            } catch (error) {
                testResults.quizAPI = false;
                updateStatus('api', 'error', 'Quiz API failed');
                log(`❌ Quiz API test failed: ${error.message}`);
                return false;
            }
        }

        function checkNetworkErrors() {
            log("🌐 Checking for network errors...");
            
            const port5000Requests = networkRequests.filter(req => req.url.includes(':5000'));
            const networkErrors = testResults.networkErrors;
            
            if (port5000Requests.length > 0) {
                updateStatus('network', 'error', `${port5000Requests.length} port 5000 requests found`);
                log(`❌ Found ${port5000Requests.length} requests to port 5000:`);
                port5000Requests.forEach(req => {
                    log(`  - ${req.method} ${req.url}`);
                });
            } else {
                updateStatus('network', 'success', 'No port 5000 requests');
                log("✅ No requests to port 5000 detected");
            }
            
            if (networkErrors.length > 0) {
                log(`❌ Found ${networkErrors.length} network errors:`);
                networkErrors.forEach(error => {
                    log(`  - ${error.type}: ${error.url} - ${error.error}`);
                });
            } else {
                log("✅ No network errors detected");
            }
        }

        async function runFullTestSuite() {
            log("🚀 Starting full test suite...");
            log("==================================================");
            
            const backendOk = await testBackendHealth();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const authOk = await testAuthentication();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const apiOk = await testQuizAPI();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            checkNetworkErrors();
            
            // Summary
            log("==================================================");
            log("📋 Test Suite Summary:");
            log(`Backend Health: ${backendOk ? '✅ PASS' : '❌ FAIL'}`);
            log(`Authentication: ${authOk ? '✅ PASS' : '❌ FAIL'}`);
            log(`Quiz API: ${apiOk ? '✅ PASS' : '❌ FAIL'}`);
            log(`Network Clean: ${testResults.networkErrors.length === 0 ? '✅ PASS' : '❌ FAIL'}`);
            
            const allTestsPassed = backendOk && authOk && apiOk && testResults.networkErrors.length === 0;
            log(`\n🎯 OVERALL RESULT: ${allTestsPassed ? '✅ ALL TESTS PASSED' : '❌ SOME TESTS FAILED'}`);
            
            if (allTestsPassed) {
                log("\n🎉 Quiz Management is working correctly!");
                log("The port 5000 issue has been resolved.");
            } else {
                log("\n⚠️ Some issues remain. Check the detailed analysis.");
            }
        }

        async function simulateQuizManagement() {
            log("🎯 Simulating Quiz Management workflow...", 'simulation-output');
            
            if (!authToken) {
                log("❌ Please run authentication test first", 'simulation-output');
                return;
            }
            
            try {
                // 1. Load subjects
                log("1. Loading subjects...", 'simulation-output');
                const subjectsResponse = await fetch('http://localhost:8000/api/admin/subjects', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const subjectsData = await subjectsResponse.json();
                log(`✅ Loaded ${subjectsData.data?.length || 0} subjects`, 'simulation-output');
                
                // 2. Load quizzes with pagination
                log("2. Loading quizzes (page 1)...", 'simulation-output');
                const quizzesResponse = await fetch('http://localhost:8000/api/admin/quizzes?page=1&per_page=5', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const quizzesData = await quizzesResponse.json();
                
                if (quizzesData.success) {
                    log(`✅ Loaded ${quizzesData.data.quizzes.length} quizzes`, 'simulation-output');
                    log(`Total pages: ${quizzesData.data.total_pages}`, 'simulation-output');
                    
                    // Display first quiz if available
                    if (quizzesData.data.quizzes.length > 0) {
                        const firstQuiz = quizzesData.data.quizzes[0];
                        log(`\nFirst quiz preview:`, 'simulation-output');
                        log(`- Title: ${firstQuiz.title}`, 'simulation-output');
                        log(`- Subject: ${firstQuiz.subject_name || 'N/A'}`, 'simulation-output');
                        log(`- Questions: ${firstQuiz.questions?.length || 0}`, 'simulation-output');
                        log(`- Difficulty: ${firstQuiz.difficulty || 'N/A'}`, 'simulation-output');
                    }
                } else {
                    log(`❌ Failed to load quizzes: ${quizzesData.message}`, 'simulation-output');
                }
                
                log("\n✅ Quiz Management simulation completed", 'simulation-output');
                
            } catch (error) {
                log(`❌ Simulation failed: ${error.message}`, 'simulation-output');
            }
        }

        // Initialize monitoring when page loads
        window.addEventListener('load', () => {
            initNetworkMonitoring();
            log("Network monitoring initialized");
        });

        // Monitor console errors
        window.addEventListener('error', (event) => {
            testResults.networkErrors.push({
                type: 'javascript',
                url: event.filename,
                error: event.message
            });
            log(`JS ERROR: ${event.message}`, 'network-monitor');
        });
    </script>
</body>
</html>
