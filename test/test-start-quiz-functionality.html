<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Start Quiz Functionality Test</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; padding: 20px; margin: 20px 0; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.success:hover { background: #1e7e34; }
        pre { background: #f8f9fa; padding: 10px; border: 1px solid #e9ecef; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Start Quiz Functionality Test</h1>
    <p>Testing the "Start Quiz" button functionality after fixing the API integration.</p>

    <div class="test-section info">
        <h3>Issue Fixed</h3>
        <p>The "Start Quiz" button was not working because:</p>
        <ul>
            <li>1. QuizTaking component was using old api service instead of useAuth api</li>
            <li>2. API endpoints were missing /api prefix</li>
            <li>3. Response handling needed to accommodate backend data structure</li>
        </ul>
    </div>

    <div class="test-section info">
        <h3>Fixes Applied</h3>
        <ul>
            <li>‚úÖ Updated QuizTaking component to use useAuth api instance</li>
            <li>‚úÖ Fixed API endpoints: /api/quiz/{id}/start, /api/quiz/{id}/submit, /api/quiz/{id}/save</li>
            <li>‚úÖ Updated response handling to correctly extract quiz data and questions</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>1. Test Quiz Start API</h3>
        <button onclick="testQuizStartAPI()">Test Quiz Start API</button>
        <div id="api-result"></div>
    </div>

    <div class="test-section">
        <h3>2. Navigation Test</h3>
        <button onclick="openQuizBrowse()">Open Quiz Browse Page</button>
        <button onclick="openQuizTaking()">Open Quiz Taking Page</button>
        <div id="nav-result"></div>
    </div>

    <div class="test-section">
        <h3>3. Full User Journey Test</h3>
        <button onclick="startFullTest()">Test Complete Journey</button>
        <div id="journey-result"></div>
    </div>

    <script>
        let authToken = null;

        async function testQuizStartAPI() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.innerHTML = '<p>Testing quiz start API...</p>';

            try {
                // Login first
                const loginResponse = await axios.post('http://localhost:8000/api/auth/login', {
                    email: 'admin@prepcheck.com',
                    password: 'admin123'
                });

                authToken = loginResponse.data.access_token;

                // Test quiz start endpoint
                const startResponse = await axios.post('http://localhost:8000/api/quiz/1/start', {}, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                resultDiv.className = 'success';
                resultDiv.innerHTML = `
                    <h4>‚úÖ Quiz Start API Success</h4>
                    <p><strong>Quiz:</strong> ${startResponse.data.quiz.title}</p>
                    <p><strong>Questions:</strong> ${startResponse.data.questions.length}</p>
                    <p><strong>Time Remaining:</strong> ${startResponse.data.time_remaining} seconds</p>
                    <p><strong>Message:</strong> ${startResponse.data.message}</p>
                    <details>
                        <summary>View Full Response</summary>
                        <pre>${JSON.stringify(startResponse.data, null, 2)}</pre>
                    </details>
                `;
            } catch (error) {
                console.error('Quiz start API error:', error);
                resultDiv.className = 'error';
                resultDiv.innerHTML = `
                    <h4>‚ùå Quiz Start API Failed</h4>
                    <p><strong>Error:</strong> ${error.response?.data?.error || error.message}</p>
                    <pre>${JSON.stringify(error.response?.data, null, 2)}</pre>
                `;
            }
        }

        function openQuizBrowse() {
            const resultDiv = document.getElementById('nav-result');
            resultDiv.className = 'info';
            resultDiv.innerHTML = '<p>Opening quiz browse page... Click "Start Quiz" on any quiz to test the functionality.</p>';
            window.open('http://localhost:3000/quizzes', '_blank');
        }

        function openQuizTaking() {
            const resultDiv = document.getElementById('nav-result');
            resultDiv.className = 'info';
            resultDiv.innerHTML = '<p>Opening quiz taking page directly... This should load the quiz interface.</p>';
            window.open('http://localhost:3000/quiz/1/take', '_blank');
        }

        async function startFullTest() {
            const resultDiv = document.getElementById('journey-result');
            resultDiv.innerHTML = '<p>Running full user journey test...</p>';
            
            const steps = [];
            
            try {
                // Step 1: Login
                steps.push('üîê Logging in...');
                resultDiv.innerHTML = `<p>${steps.join('<br>')}</p>`;
                
                const loginResponse = await axios.post('http://localhost:8000/api/auth/login', {
                    email: 'admin@prepcheck.com',
                    password: 'admin123'
                });
                authToken = loginResponse.data.access_token;
                steps.push('‚úÖ Login successful');
                resultDiv.innerHTML = `<p>${steps.join('<br>')}</p>`;
                
                // Step 2: Browse quizzes
                steps.push('üìö Fetching available quizzes...');
                resultDiv.innerHTML = `<p>${steps.join('<br>')}</p>`;
                
                const browseResponse = await axios.get('http://localhost:8000/api/quiz/browse', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                steps.push(`‚úÖ Found ${browseResponse.data.quizzes.length} quizzes`);
                resultDiv.innerHTML = `<p>${steps.join('<br>')}</p>`;
                
                // Step 3: Start a quiz
                steps.push('üöÄ Starting quiz...');
                resultDiv.innerHTML = `<p>${steps.join('<br>')}</p>`;
                
                const quizId = browseResponse.data.quizzes[0].id;
                const startResponse = await axios.post(`http://localhost:8000/api/quiz/${quizId}/start`, {}, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                steps.push(`‚úÖ Quiz "${startResponse.data.quiz.title}" started successfully`);
                steps.push(`üìù ${startResponse.data.questions.length} questions loaded`);
                steps.push(`‚è±Ô∏è ${startResponse.data.time_remaining} seconds available`);
                
                resultDiv.className = 'success';
                resultDiv.innerHTML = `
                    <h4>‚úÖ Full Journey Test Successful</h4>
                    <p>${steps.join('<br>')}</p>
                    <p><strong>‚úÖ All functionality is working correctly!</strong></p>
                    <p>Users can now:</p>
                    <ul>
                        <li>Browse available quizzes</li>
                        <li>Click "Start Quiz" button</li>
                        <li>Load quiz questions and interface</li>
                        <li>Take quizzes with proper authentication</li>
                    </ul>
                `;
                
            } catch (error) {
                console.error('Full test error:', error);
                steps.push(`‚ùå Error: ${error.response?.data?.error || error.message}`);
                resultDiv.className = 'error';
                resultDiv.innerHTML = `
                    <h4>‚ùå Full Journey Test Failed</h4>
                    <p>${steps.join('<br>')}</p>
                    <pre>${JSON.stringify(error.response?.data, null, 2)}</pre>
                `;
            }
        }

        // Auto-test on page load
        window.addEventListener('load', () => {
            console.log('Start quiz functionality test loaded');
            // Auto test the API
            testQuizStartAPI();
        });
    </script>
</body>
</html>
