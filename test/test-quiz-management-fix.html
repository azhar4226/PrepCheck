<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Quiz Management Fix</title>
    <!-- Updated CSP to allow both ports -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval';
        style-src 'self' 'unsafe-inline';
        connect-src 'self' http://localhost:8000 http://localhost:5000;
    ">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background-color: #0056b3; }
        .output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        .log-success { background-color: #d4edda; }
        .log-error { background-color: #f8d7da; }
        .log-info { background-color: #e2e3e5; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Quiz Management Port Fix Test</h1>
        <p>Testing that Quiz Management now correctly connects to port 8000 instead of 5000</p>

        <div class="test-section info">
            <h3>üìã Test Instructions</h3>
            <ol>
                <li>Click "Test Backend Connection" to verify backend is on port 8000</li>
                <li>Click "Test Admin Login" to authenticate</li>
                <li>Click "Test Quiz Management API" to verify quiz loading</li>
                <li>Check browser console for any remaining port 5000 errors</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>üîå Backend Connection Test</h3>
            <button class="btn" onclick="testBackendConnection()">Test Backend Connection</button>
            <div id="backend-test-output" class="output"></div>
        </div>

        <div class="test-section">
            <h3>üîê Admin Authentication</h3>
            <input type="email" id="admin-email" placeholder="Admin Email" value="admin@test.com">
            <input type="password" id="admin-password" placeholder="Admin Password" value="admin123">
            <button class="btn" onclick="testAdminLogin()">Test Admin Login</button>
            <div id="auth-test-output" class="output"></div>
        </div>

        <div class="test-section">
            <h3>üìä Quiz Management API Test</h3>
            <button class="btn" onclick="testQuizManagementAPI()">Test Quiz Management API</button>
            <div id="quiz-api-output" class="output"></div>
        </div>

        <div class="test-section">
            <h3>üåê Network Monitor</h3>
            <button class="btn" onclick="startNetworkMonitor()">Start Network Monitoring</button>
            <button class="btn" onclick="clearNetworkLog()">Clear Log</button>
            <div id="network-log" class="output"></div>
        </div>

        <div id="test-results" class="test-section">
            <h3>üìà Test Results Summary</h3>
            <div id="results-summary" class="output">Click tests above to see results...</div>
        </div>
    </div>

    <script>
        let authToken = null;
        let networkLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            networkLog.push({ message: logEntry, type });
            
            // Update network monitor if it's active
            updateNetworkLog();
            
            console.log(logEntry);
        }

        function updateNetworkLog() {
            const logElement = document.getElementById('network-log');
            if (logElement) {
                logElement.innerHTML = networkLog.map(entry => 
                    `<div class="log-entry log-${entry.type}">${entry.message}</div>`
                ).join('');
                logElement.scrollTop = logElement.scrollHeight;
            }
        }

        function clearNetworkLog() {
            networkLog = [];
            updateNetworkLog();
        }

        function startNetworkMonitor() {
            log('Network monitoring started', 'info');
            
            // Override fetch to monitor requests
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                const url = typeof args[0] === 'string' ? args[0] : args[0].url;
                log(`FETCH: ${url}`, 'info');
                
                return originalFetch.apply(this, args)
                    .then(response => {
                        log(`FETCH RESPONSE: ${url} - ${response.status} ${response.statusText}`, 
                            response.ok ? 'success' : 'error');
                        return response;
                    })
                    .catch(error => {
                        log(`FETCH ERROR: ${url} - ${error.message}`, 'error');
                        throw error;
                    });
            };

            // Monitor XMLHttpRequest
            const originalXHROpen = XMLHttpRequest.prototype.open;
            XMLHttpRequest.prototype.open = function(method, url, ...args) {
                this._url = url;
                log(`XHR: ${method} ${url}`, 'info');
                return originalXHROpen.apply(this, [method, url, ...args]);
            };

            const originalXHRSend = XMLHttpRequest.prototype.send;
            XMLHttpRequest.prototype.send = function(...args) {
                this.addEventListener('load', () => {
                    log(`XHR RESPONSE: ${this._url} - ${this.status} ${this.statusText}`, 
                        this.status >= 200 && this.status < 400 ? 'success' : 'error');
                });
                this.addEventListener('error', () => {
                    log(`XHR ERROR: ${this._url}`, 'error');
                });
                return originalXHRSend.apply(this, args);
            };
        }

        async function testBackendConnection() {
            const output = document.getElementById('backend-test-output');
            output.innerHTML = 'Testing backend connection...\n';
            
            try {
                log('Testing backend connection on port 8000', 'info');
                
                // Test port 8000 (correct port)
                const response8000 = await fetch('http://localhost:8000/api/health', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                output.innerHTML += `‚úÖ Port 8000: ${response8000.status} ${response8000.statusText}\n`;
                log(`Backend on port 8000: ${response8000.status}`, 'success');
                
                // Test port 5000 (should fail or be different service)
                try {
                    const response5000 = await fetch('http://localhost:5000/api/health', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    output.innerHTML += `‚ö†Ô∏è Port 5000: ${response5000.status} ${response5000.statusText} (should not be used)\n`;
                    log(`Unexpected response on port 5000: ${response5000.status}`, 'error');
                } catch (error) {
                    output.innerHTML += `‚úÖ Port 5000: Connection refused (as expected)\n`;
                    log('Port 5000 correctly unavailable', 'success');
                }
                
                output.innerHTML += '\n‚úÖ Backend connection test completed';
                
            } catch (error) {
                output.innerHTML += `‚ùå Error: ${error.message}\n`;
                log(`Backend connection error: ${error.message}`, 'error');
            }
        }

        async function testAdminLogin() {
            const output = document.getElementById('auth-test-output');
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            
            output.innerHTML = 'Attempting admin login...\n';
            
            try {
                log('Attempting admin login on port 8000', 'info');
                
                const response = await fetch('http://localhost:8000/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    authToken = data.data.access_token;
                    output.innerHTML += `‚úÖ Login successful! Token received.\n`;
                    output.innerHTML += `User: ${data.data.user.email} (${data.data.user.role})\n`;
                    log('Admin login successful', 'success');
                } else {
                    output.innerHTML += `‚ùå Login failed: ${data.message || 'Unknown error'}\n`;
                    log(`Login failed: ${data.message}`, 'error');
                }
                
            } catch (error) {
                output.innerHTML += `‚ùå Login error: ${error.message}\n`;
                log(`Login error: ${error.message}`, 'error');
            }
        }

        async function testQuizManagementAPI() {
            const output = document.getElementById('quiz-api-output');
            
            if (!authToken) {
                output.innerHTML = '‚ùå Please login first\n';
                return;
            }
            
            output.innerHTML = 'Testing Quiz Management API...\n';
            
            try {
                log('Testing quiz management API with authentication', 'info');
                
                const response = await fetch('http://localhost:8000/api/admin/quizzes', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    output.innerHTML += `‚úÖ API Response: ${response.status} ${response.statusText}\n`;
                    output.innerHTML += `Success: ${data.success}\n`;
                    output.innerHTML += `Quizzes found: ${data.data?.quizzes?.length || 0}\n`;
                    output.innerHTML += `Total pages: ${data.data?.total_pages || 'N/A'}\n`;
                    
                    if (data.data?.quizzes?.length > 0) {
                        output.innerHTML += `\nFirst quiz: ${JSON.stringify(data.data.quizzes[0], null, 2)}\n`;
                    }
                    
                    log(`Quiz API successful: ${data.data?.quizzes?.length || 0} quizzes`, 'success');
                } else {
                    output.innerHTML += `‚ùå API Error: ${response.status} ${response.statusText}\n`;
                    output.innerHTML += `Message: ${data.message || 'Unknown error'}\n`;
                    log(`Quiz API error: ${response.status} ${data.message}`, 'error');
                }
                
            } catch (error) {
                output.innerHTML += `‚ùå Request failed: ${error.message}\n`;
                log(`Quiz API request failed: ${error.message}`, 'error');
            }
        }

        // Initialize network monitoring on page load
        window.addEventListener('load', () => {
            log('Page loaded, monitoring initialized', 'info');
            startNetworkMonitor();
        });

        // Monitor console errors
        window.addEventListener('error', (event) => {
            log(`JS ERROR: ${event.message} at ${event.filename}:${event.lineno}`, 'error');
        });
    </script>
</body>
</html>
