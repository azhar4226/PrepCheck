<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Management Test - PrepCheck</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .test-results { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Profile Management Test</h1>
        
        <!-- Test Status -->
        <div id="status" class="alert alert-info">
            <strong>Status:</strong> Testing profile management functionality...
        </div>

        <!-- Login Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>1. Authentication Test</h5>
            </div>
            <div class="card-body">
                <form id="loginForm">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="email" class="form-label">Email:</label>
                            <input type="email" class="form-control" id="email" value="admin@prepcheck.com" required>
                        </div>
                        <div class="col-md-6">
                            <label for="password" class="form-label">Password:</label>
                            <input type="password" class="form-control" id="password" value="admin123" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary mt-3">Login</button>
                </form>
                <div id="loginResult" class="mt-3"></div>
            </div>
        </div>

        <!-- Profile Management Tests -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>2. Profile Management Tests</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>User Profile Tests</h6>
                        <button id="testGetProfile" class="btn btn-outline-primary btn-sm mb-2">Get User Profile</button><br>
                        <button id="testUpdateProfile" class="btn btn-outline-success btn-sm mb-2">Update Profile</button><br>
                        <button id="testChangePassword" class="btn btn-outline-warning btn-sm mb-2">Change Password</button><br>
                        <div id="userProfileResult" class="small mt-2"></div>
                    </div>
                    <div class="col-md-6">
                        <h6>Admin Profile Tests</h6>
                        <button id="testGetAdminProfile" class="btn btn-outline-primary btn-sm mb-2">Get Admin Profile</button><br>
                        <button id="testUpdateAdminProfile" class="btn btn-outline-success btn-sm mb-2">Update Admin Profile</button><br>
                        <button id="testGetUsers" class="btn btn-outline-info btn-sm mb-2">Get All Users</button><br>
                        <div id="adminProfileResult" class="small mt-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Upload Test -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>3. File Upload Test</h5>
            </div>
            <div class="card-body">
                <label for="profilePicture" class="form-label">Profile Picture</label>
                <input type="file" id="profilePicture" accept="image/*" class="form-control mb-3">
                <button id="testUploadPicture" class="btn btn-outline-primary">Upload Profile Picture</button>
                <button id="testDeletePicture" class="btn btn-outline-danger ms-2">Delete Profile Picture</button>
                <div id="uploadResult" class="mt-3"></div>
            </div>
        </div>

        <!-- Test Results -->
        <div class="card">
            <div class="card-header">
                <h5>Test Results</h5>
            </div>
            <div class="card-body">
                <div id="testResults" class="test-results">
                    <p class="text-muted">Test results will appear here...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let authToken = null;

        // Utility functions
        function logResult(message, type = 'info') {
            const results = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-danger' : 'alert-info';
            
            results.innerHTML = `
                <div class="alert ${alertClass} alert-sm">
                    <small><strong>[${timestamp}]</strong> ${message}</small>
                </div>
            ` + results.innerHTML;
        }

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-danger' : 'alert-info';
            status.className = `alert ${alertClass}`;
            status.innerHTML = `<strong>Status:</strong> ${message}`;
        }

        async function makeRequest(endpoint, options = {}) {
            const url = `${API_BASE}${endpoint}`;
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                },
                ...options
            };

            if (config.body && typeof config.body === 'object' && !(config.body instanceof FormData)) {
                config.body = JSON.stringify(config.body);
            }

            try {
                const response = await fetch(url, config);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }
                
                return data;
            } catch (error) {
                logResult(`Request failed: ${error.message}`, 'error');
                throw error;
            }
        }

        // Test functions
        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const data = await makeRequest('/auth/login', {
                    method: 'POST',
                    body: { email, password }
                });

                authToken = data.access_token;
                document.getElementById('loginResult').innerHTML = 
                    '<div class="alert alert-success">✓ Login successful!</div>';
                logResult('Authentication successful', 'success');
                updateStatus('Logged in successfully', 'success');
                return true;
            } catch (error) {
                document.getElementById('loginResult').innerHTML = 
                    `<div class="alert alert-danger">✗ Login failed: ${error.message}</div>`;
                logResult(`Login failed: ${error.message}`, 'error');
                return false;
            }
        }

        async function testGetProfile() {
            try {
                const data = await makeRequest('/user/profile');
                document.getElementById('userProfileResult').innerHTML = 
                    `<div class="alert alert-success">✓ Profile loaded: ${data.user.full_name}</div>`;
                logResult(`User profile loaded successfully: ${data.user.email}`, 'success');
            } catch (error) {
                document.getElementById('userProfileResult').innerHTML = 
                    `<div class="alert alert-danger">✗ Failed: ${error.message}</div>`;
            }
        }

        async function testUpdateProfile() {
            try {
                const updateData = {
                    full_name: 'Test User Updated',
                    bio: 'Updated bio from test',
                    phone: '+1-555-0123',
                    country: 'United States'
                };
                
                const data = await makeRequest('/user/profile', {
                    method: 'PUT',
                    body: updateData
                });
                
                document.getElementById('userProfileResult').innerHTML = 
                    '<div class="alert alert-success">✓ Profile updated successfully</div>';
                logResult('Profile updated successfully', 'success');
            } catch (error) {
                document.getElementById('userProfileResult').innerHTML = 
                    `<div class="alert alert-danger">✗ Update failed: ${error.message}</div>`;
            }
        }

        async function testGetAdminProfile() {
            try {
                const data = await makeRequest('/admin/profile');
                document.getElementById('adminProfileResult').innerHTML = 
                    `<div class="alert alert-success">✓ Admin profile loaded: ${data.admin.full_name}</div>`;
                logResult(`Admin profile loaded: ${data.admin.email}`, 'success');
            } catch (error) {
                document.getElementById('adminProfileResult').innerHTML = 
                    `<div class="alert alert-danger">✗ Failed: ${error.message}</div>`;
            }
        }

        async function testUpdateAdminProfile() {
            try {
                const updateData = {
                    full_name: 'Admin User Updated',
                    bio: 'Updated admin bio',
                    timezone: 'America/New_York'
                };
                
                await makeRequest('/admin/profile', {
                    method: 'PUT',
                    body: updateData
                });
                
                document.getElementById('adminProfileResult').innerHTML = 
                    '<div class="alert alert-success">✓ Admin profile updated</div>';
                logResult('Admin profile updated successfully', 'success');
            } catch (error) {
                document.getElementById('adminProfileResult').innerHTML = 
                    `<div class="alert alert-danger">✗ Update failed: ${error.message}</div>`;
            }
        }

        async function testGetUsers() {
            try {
                const data = await makeRequest('/admin/users?page=1&per_page=5');
                document.getElementById('adminProfileResult').innerHTML = 
                    `<div class="alert alert-success">✓ Loaded ${data.users.length} users (total: ${data.total})</div>`;
                logResult(`Loaded ${data.users.length} users from database`, 'success');
            } catch (error) {
                document.getElementById('adminProfileResult').innerHTML = 
                    `<div class="alert alert-danger">✗ Failed: ${error.message}</div>`;
            }
        }

        async function testUploadPicture() {
            const fileInput = document.getElementById('profilePicture');
            const file = fileInput.files[0];
            
            if (!file) {
                document.getElementById('uploadResult').innerHTML = 
                    '<div class="alert alert-warning">Please select a file first</div>';
                return;
            }

            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`${API_BASE}/user/profile/picture`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Upload failed');
                }
                
                document.getElementById('uploadResult').innerHTML = 
                    '<div class="alert alert-success">✓ Profile picture uploaded successfully</div>';
                logResult(`Profile picture uploaded: ${data.profile_picture_url}`, 'success');
            } catch (error) {
                document.getElementById('uploadResult').innerHTML = 
                    `<div class="alert alert-danger">✗ Upload failed: ${error.message}</div>`;
                logResult(`Upload failed: ${error.message}`, 'error');
            }
        }

        async function testDeletePicture() {
            try {
                await makeRequest('/user/profile/picture', { method: 'DELETE' });
                document.getElementById('uploadResult').innerHTML = 
                    '<div class="alert alert-success">✓ Profile picture deleted</div>';
                logResult('Profile picture deleted successfully', 'success');
            } catch (error) {
                document.getElementById('uploadResult').innerHTML = 
                    `<div class="alert alert-danger">✗ Delete failed: ${error.message}</div>`;
            }
        }

        // Event listeners
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await testLogin();
        });

        document.getElementById('testGetProfile').addEventListener('click', testGetProfile);
        document.getElementById('testUpdateProfile').addEventListener('click', testUpdateProfile);
        document.getElementById('testGetAdminProfile').addEventListener('click', testGetAdminProfile);
        document.getElementById('testUpdateAdminProfile').addEventListener('click', testUpdateAdminProfile);
        document.getElementById('testGetUsers').addEventListener('click', testGetUsers);
        document.getElementById('testUploadPicture').addEventListener('click', testUploadPicture);
        document.getElementById('testDeletePicture').addEventListener('click', testDeletePicture);

        // Auto-login for testing
        setTimeout(() => {
            updateStatus('Ready to test profile management features');
            logResult('Profile management test page loaded. Click Login to start testing.', 'info');
        }, 500);
    </script>
</body>
</html>
